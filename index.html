<!DOCTYPE html><html lang="en"><head><title>index</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content=""><meta name="groc-document-path" content="index"><meta name="groc-project-path" content="README.md"><meta name="groc-github-url" content="https://github.com/natgeo/activitystreams"><link rel="stylesheet" type="text/css" media="all" href="assets/style.css"><script type="text/javascript" src="assets/behavior.js"></script><body><div id="meta"><div class="file-path"><a href="https://github.com/natgeo/activitystreams/blob/master/README.md">README.md</a></div></div><div id="document"><div class="segment"><div class="comments "><div class="wrapper"><p><a href="https://travis-ci.org/natgeo/activitystreams"><img src="https://travis-ci.org/natgeo/activitystreams.png" alt="Build Status" title="" /></a> <a href="http://waffle.io/natgeo/activitystreams"><img src="https://badge.waffle.io/natgeo/activitystreams.png?label=ready&amp;title=Ready" alt="Stories in Ready" title="" /></a></p>

<h4 id="activity-stream-service">Activity Stream Service</h4>

<h5 id="table-of-contents">Table of Contents</h5>

<ol>
<li>Introduction</li>
<li>What is Activity Stream</li>
<li>What problem is it solving?</li>
<li>Current Situation at Natgeo</li>
<li>Technology and Standared Choices</li>
<li>Graph Problems</li>
<li>Graph Structure</li>
<li>Service Point</li>
<li>Rest End Point</li>
<li>Road Map</li>
<li>Installation</li>
</ol>

<h2 id="introduction">Introduction</h2>

<p>This document provides a high level understanding of how the Activity Stream works with Neo4j and the broad structure we have defined for interacting with the database.</p>

<h2 id="technology-choices">Technology choices</h2>

<ul>
<li>Node</li>
<li>Neo4j</li>
<li>Redis</li>
</ul>

<h2 id="activity-stream-spec">Activity Stream Spec</h2>

<p>Our activity stream model conforms to the Activity Streams specification found here: http://activitystrea.ms/, where:</p>

<p><strong>ACTOR -> VERB -> OBJECT -> TARGET</strong></p>

<p>Might be implemented, for sake of example, as:</p>

<ul>
<li>mmdb<em>user -> FAVORITED -> yourshot</em>photo</li>
</ul>

<h2 id="graph-structure">Graph Structure</h2>

<p>Nodes have labels, and the naming convention for these labels represents the types of nodes we have</p>

<pre><code>{app_name}_{model}
</code></pre>

<p>For example, an mmdb User would be</p>

<pre><code>mmdb_user
</code></pre>

<p>A Yourshot photo would be</p>

<pre><code>yourshot_photo
</code></pre>

<p>An ngm article would be</p>

<pre><code>ngm_article
</code></pre>

<h3 id="node-properties">Node properties</h3>

<p>Nodes currently have the folowing properties</p>

<pre><code>aid : {int} / {slug} … open ended
api : {url}
created: {unix timestamp
updated: {unix timestamp}
</code></pre>

<p>Nodes contain a 'type' property so that we can return the label for the node. </p>

<p>For example a USER node will have the following:</p>

<pre><code>aid : 1
api: http://exampleapp.com/user/1/
created: 1388767442091
updated: 1389039127283
</code></pre>

<p>A Photo</p>

<pre><code>aid: 11121
api: http://example.com/api/v1/photo/14055
created: 1388767442091
updated: 1389039127283
</code></pre>

<h3 id="edges">Edges</h3>

<p>Edges represent relationships. They are in all caps and also have timestamps</p>

<p>List of Current Verbs:</p>

<pre><code>FAVORITED
PLEDGES
FOLLOWS
</code></pre>

<p>There shall be a master list of verbs that will be used within the graph. Users are not allowed to add new verb that are not in the master list.</p>

<h3 id="activity-service-rest-api">Activity Service REST API</h3>

<p>Get all nodes of type</p>

<pre><code>'get /api/v1/:actor' --&gt; /api/v1/mmdb_user
</code></pre>

<p>Get node of specfic id</p>

<pre><code>'get /api/v1/:actor/:actor_id' --&gt; /api/v1/mmdb_user/1
</code></pre>

<p>Get all activites of specifc actor</p>

<pre><code>'get /api/v1/:actor/:actor_id/activities' -&gt; /api/v1/mmdb_user/1/activities
</code></pre>

<p>Get all specific verbed activites of user </p>

<pre><code>'get /api/v1/:actor/:actor_id/:verb' -&gt; /api/v1/mmdb_user/1/FAVORITED
</code></pre>

<p>Getall activies verb by type of object by user</p>

<pre><code>'get /api/v1/:actor/:actor_id/:verb/:object' -&gt; api/v1/mmdb_user/1/FAVORITED/yourshot_photo
</code></pre>

<p>Get specific activity with user verbed object</p>

<pre><code>'get /api/v1/:actor/:actor_id/:verb/:object/:object_id' -&gt; api/v1/mmdb_user/FAVORITED/yourshot_photo/1212
</code></pre>

<p>Post an Activity</p>

<pre><code> 'post /api/v1/activity': 'ActivityController.postSpecificActivity',
</code></pre>

<p>Delete an Activity</p>

<pre><code>'delete /api/v1/:actor/:actor_id/:verb/:object/:object_id' -&gt; 
api/v1/mmdb_user/1/Favorited/yourshot_photo/14442
</code></pre>

<h3 id="gate-keeping">Gate Keeping</h3>

<p>For users:</p>

<pre><code>Need a valid mmdb session cookie
</code></pre>

<p>For batch requests:</p>

<pre><code>api key
</code></pre>

<p>For clients who need to establish a signed auth cookie with this service:</p>

<p>Send a blank JSONP request to / before establishing your socket connection</p>

<p>Example:
  <code>
    $.ajax({
      url: 'as.example.com',
      dataType: 'jsonp',
      timeout: 12000,
      cache: false,
      success: function(data) {
        // Establish socket
      },
      error: function(xhr, textStatus) {
        // Handle error
      }
    });
</code></p>

<h1 id="installation">Installation</h1>

<h1 id="java-jdk-17">Java JDK 1.7</h1>

<ul>
<li><p>Download the <a href="http://www.oracle.com/technetwork/java/javase/downloads/index.html">latest 1.7 JDK</a></p>

<ul><li>OSX users should just need to open the DMG and run the installer.</li>
<li>Debian</li>
<li>Download the <a href="http://www.oracle.com/technetwork/java/javase/downloads/index.html">linux jdk 7</a></li>
<li><code>tar -xvf jdk-7u2-linux-x64.tar.gz</code> (64 bit) or <code>tar -xvf jdk-7u2-linux-i586.tar.gz</code> (32 bit)</li>
<li><code>sudo mkdir -p /usr/lib/jvm</code></li>
<li><code>sudo mv ./jdk1.7.0_02 /usr/lib/jvm/jdk1.7.0</code></li>
<li><p>Next run the following:
<code>
sudo update-alternatives --install "/usr/bin/java" "java" "/usr/lib/jvm/jdk1.7.0/bin/java" 1
sudo update-alternatives --install "/usr/bin/javac" "javac" "/usr/lib/jvm/jdk1.7.0/bin/javac" 1
sudo update-alternatives --install "/usr/bin/javaws" "javaws" "/usr/lib/jvm/jdk1.7.0/bin/javaws" 1
</code></p></li>
<li><p>Change permissions:
<code>
sudo chmod a+x /usr/bin/java 
sudo chmod a+x /usr/bin/javac
sudo chmod a+x /usr/bin/javaws
sudo chown -R root:root /usr/lib/jvm/jdk1.7.0
</code></p></li>
<li><p><code>sudo update-alternatives --config java</code></p></li>
<li><p>You will see output similar one below - choose the number of jdk1.7.0 - for example 3 in this list:
```
$sudo update-alternatives --config java
There are 3 choices for the alternative java (providing /usr/bin/java).</p>

<p>Selection Path Priority Status
————————————————————
0 /usr/lib/jvm/java-6-openjdk/jre/bin/java 1061 auto mode
1 /usr/lib/jvm/java-6-openjdk/jre/bin/java 1061 manual mode
2 /usr/lib/jvm/java-6-sun/jre/bin/java 63 manual mode
3 /usr/lib/jvm/jdk1.7.0/jre/bin/java 3 manual mode</p>

<p>Press enter to keep the current choice[*], or type selection number: 3
update-alternatives: using /usr/lib/jvm/jdk1.7.0/jre/bin/java to provide /usr/bin/java (java) in manual mode.
```</p></li>
<li><code>java -version</code> to chech if you are using the correct version</li>
<li>Repeat for <code>sudo update-alternatives --config javac</code> and <code>sudo update-alternatives --config javaws</code></li></ul></li>
</ul>

<h1 id="nodehttpnodejsorg"><a href="http://nodejs.org">Node</a></h1>

<p>(Until any of this goes to production we are not version locked, but if you must, we use 0.10.24 locally)</p>

<ul>
<li><p>OSX with Homebrew</p>

<ul><li><code>brew update</code></li>
<li><code>brew tap homebrew/versions</code></li>
<li><code>brew versions node</code></li>
<li><code>brew install node --upgrade</code></li></ul></li>
<li><p>Debian (Build from source) - In Ubuntu you can use system package, see below.
<code>
sudo apt-get install python g++ make checkinstall
mkdir ~/src &amp;&amp; cd ~/src
wget -N http://nodejs.org/dist/node-latest.tar.gz
tar xzvf node-latest.tar.gz &amp;&amp; node-v* #(remove the "v" in front of the version number in the dialog)
./configure
checkinstall
sudo dpkg -i node_*
</code></p>

<p>Note: when you call checkinstall, make sure you edit the version when presented with:</p>

<p>```
"This package will be built according to these values:</p>

<p>0 - Maintainer: [ root@debian ] 1 - Summary: [ Node.js v0.10.24 ] 2 - Name: [ node ] 3 - Version: [ v0.10.24 ]"
```
Version should be 0.10.24 NOT v0.10.24 otherwise your build will fail.</p>

<p>From https://github.com/joyent/node/wiki/Installing-Node.js-via-package-manager</p></li>
<li><p>Ubuntu (apt-get) More friendly with ubuntu</p>

<ul><li><code>sudo apt-get install nodejs</code></li></ul></li>
</ul>

<p>Note that in some Ubuntu version, nodejs is installed as nodejs and some programs looks for node. In this case, you need to symlink to nodejs:</p>

<pre><code>sudo ln -s /usr/bin/nodejs /usr/bin/node
</code></pre>

<h1 id="npm-1314">NPM 1.3.14</h1>

<ul>
<li>OSX with Homebrew:
<ul><li>NPM was recently removed from Homebrew, so manually install <code>curl https://npmjs.org/install.sh | sh</code></li></ul></li>
</ul>

<h1 id="neo4j201httpwwwneo4jorg"><a href="http://www.neo4j.org">Neo4j 2.0.1!</a></h1>

<ul>
<li>Download the <a href="http://www.neo4j.org/download">Neo4j 2.0</a></li>
<li>OSX:
<ul><li><code>brew update</code></li>
<li><code>brew install neo4j</code></li>
<li><code>neo4j install</code></li>
<li>Add to launchctl to make your life easier</li>
<li><code>neo4j start</code></li></ul></li>
<li>Debian/Linux
<ul><li><code>tar xzvf neo4j-community.2.0.3-unix.tar.gz</code></li>
<li><code>mv neo4j-community.2.0.3-unix /etc/neo4j &amp;&amp; cd /etc/neo4j</code></li>
<li><code>bin/neo4j-installer</code></li>
<li><code>sudo service neo4j-service start</code></li>
<li>Uncomment "org.neo4j.server.webserver.address=0.0.0.0" in /etc/neo4j/conf/neo4j-server.properties for neo4j admin area</li></ul></li>
<li>Neo4j Web Interface is at 'http://localhost:7474/browser/'</li>
</ul>

<h1 id="redishttpredisio"><a href="http://redis.io/">Redis</a></h1>

<ul>
<li>OSX with Homebrew:
<ul><li><code>brew install redis</code></li>
<li><code>launchctl load ~/Library/LaunchAgents/homebrew.mxcl.redis.plist</code></li>
<li>To test that your server is running:  <code>redis-cli</code>.  You should be at a prompt "127.0.0.1:6379"</li>
<li><code>exit</code></li></ul></li>
</ul>

<h1 id="dependencies">Dependencies</h1>

<p>These files are part of the package.json file, so NPM is able to install them all with one command. <code>npm install</code></p>

<ul>
<li><a href="https://github.com/bretcope/neo4j-js">Neo4j-JS</a> (this dependency might be swapped out soon)</li>
<li><a href="http://sailsjs.org/#!documentation">Sails.JS</a></li>
<li><a href="https://github.com/natgeo/sails-neo4j">Sails-Neo4j</a></li>
</ul>

<h1 id="maven">Maven</h1>

<ul>
<li><code>brew install maven</code></li>
</ul>

<h1 id="bundle">Bundle</h1>

<p><em>This takes care of ruby/sass dependencies</em>
* <code>gem install bundler &amp;&amp; bundle install</code>
* <code>gem install sass compass</code></p>

<h1 id="ruby">Ruby</h1>

<pre><code>sudo apt-get install ruby ruby-dev gcc build-essential
</code></pre>

<h1 id="environment-setup">Environment Setup</h1>

<pre><code>mkdir ~/code/activitystreams
cd ~/code/activitystreams
git clone git@github.com:natgeo/activitystreams.git .
cd activitystreams
npm install
</code></pre>

<p>Also clone git@github.com:natgeo/modules-activitystream.git, git@github.com:natgeo/modules-activitysnippet.git and https://github.com/natgeo/sails-neo4j.git
run npm install in all repos:</p>

<pre><code>cd ~/code/
git clone git@github.com:natgeo/modules-activitystream.git
cd modules-activitystream
npm install
</code></pre>

<pre><code>cd ~/code/
git clone git@github.com:natgeo/modules-activitysnippet.git
cd modules-activitysnippet
npm install
</code></pre>

<pre><code>cd ~/code/
git clone git@github.com:natgeo/sails-neo4j.git
cd sails-neo4j 
npm install
</code></pre>

<p>For each one of the mentioned Repos you must run:</p>

<pre><code>npm install
bower install
gem install
</code></pre>

<p>To run your server: <code>neo4j-server start</code> then <code>sails lift</code>
To view your server, visit http://localhost:9365</p>

<h1 id="environment-config-overrides">Environment Config Overrides</h1>

<p>The config/local.js file should include any settings specifically for your
development computer (db passwords, etc.) - See http://sailsjs.org/#!documentation/config.local. <br />
We take this a step further, so that we can have different 'local' settings
based on the environment (development or production), and the config/local.js
file was updated to reflect this.</p>

<p>The environment-specific settings are found in /config/environments/.  The file
at config/local.js will check the current environment (from process.env.NODE_ENV
or defaults to 'development'), then load settings from config/environments/<environment>.</p>

<p>Also note that, if needed, you can create a file in /config/environments/
called 'myLocal.js'.  This file is included in .gitignore and will not be
committed, and should only be used if your particular local development
environment needs further customizations from what is found in the existing
'development.js' configuration module.</p>

<h4 id="important">Important:</h4>

<p>In order to create a more secure environment, we are overriding the session secret key in the specific environment confs.
Therefore, you should create a myLocal.js file in the environments folder and add:</p>

<pre><code>module.exports.session = {
  secret: 'replace with your secret key'
};
</code></pre>

<hr />

<h1 id="activity-streams-demo">Activity Streams Demo</h1>

<p>A simple demo page for the NatGeo Activity Streams project</p>

<h1 id="etchosts-file">/etc/hosts file</h1>

<p>add as.dev.yourhostnamehere.com to your /etc/hosts file</p>

<h1 id="usage">Usage</h1>

<p>A local instance of MMDB is also required for signing in and favoriting an image.  Clone the MMDB
repo, run through the installer, and run it on port 8000.  This sails server should be running as well.</p>

<p>Access the demo at http://as.nationalgeographic.com:9365/as-demo.  If you are not
on the .nationalgeographic.com domain, then the header controls will not display.</p>

<h1 id="sample-demo-script">Sample Demo Script</h1>

<ol>
<li>Access the page: http://as.nationalgeographic.com:6935/as-demo.html</li>
<li>Click on a heart underneath a page.  You should see an alert that tells you to log in.</li>
<li>Log in with a known account.</li>
<li>Click on a heart underneath a picture.  It should turn from black to pink.</li>
<li>Refresh the page.  The image you favorited should still have a pink heart.</li>
<li>Either use another browser or clear your browser cache. (<strong>SEE KNOWN ISSUES</strong>)</li>
<li>Refresh the page.  The hearts should be black and you should be logged out.</li>
<li>Log in and refresh the page.  The image you favorited should be pink.</li>
</ol>

<h1 id="testing">Testing</h1>

<p>We are using the Mocha testing framework and have implemented it using grunt.  All tests live in /tests.
While the Sails service relies on itself and will lift/lower itself, Neo4j can be mimicked so that the
service tests can run independent.  You can set two environment variables in each of your tests:</p>

<ul>
<li><p>process.env.testMode = true
True: Runs mimicked Neo4j responses
Undefined:  Runs queries against the live database  (either comment out or delete the setting)</p></li>
<li><p>process.env.testModeDebug = true:false
True:  Displays cypher queries in the test console when they run for each test
False:  Does not display cypher queries in the test console</p></li>
</ul>

<p>To mimic the Neo4j service, you will need to require Nock and set up a server to intercept the host:port.
All this server needs to do is to capture requests on '/db/data/' and to reply with a 200 response.  Be sure
to clean up after the Nock service by running <code>nock.cleanAll();</code> after each test and <code>nock.restore();</code> after all
tests are done.  For more info on Nock, visit: https://github.com/pgte/nock</p>

<p>To lift/lower your Sails server, you need to require Sails and then issue the lift command with your config
options (ports, adapters, etc.).  An example to start the server:</p>

<pre><code>// Run a sails instance using the Neo4j adapter -- ran in the before() function
require('sails').lift({
    port: 9365,
    adapters: {
        default: 'neo4j' // defined in config/adapters.js
    }
}, done);
</code></pre>

<pre><code>// Lower a sails instance after all tests are done -- ran in the after() function
sails.lower();
</code></pre>

<p>In the view controller (api/controllers/) is where you would supply the test data you want returned to your
tests.  An example structure that the views support:</p>

<pre><code>myView: function(req, res) {
    var q = [
            // Cpyher query
            'MATCH (n)',
            'RETURN n'
        ];
    if (typeof process.env.testMode === undefined) {
        View.adapter.query(q,{}, function(err, results) {
                if (err) { return res.json(err); }
                res.json(results);
            }
        );
    } else {
        if (typeof process.env.testModeDebug !== undefined &amp;&amp; process.env.testModeDebug === true) {
            // Display debug query in console
            View.adapter.query(q, {});
        }
        res.json(200, { // return data here in JSON format });
    }
}
</code></pre>

<p>To run test: <code>grunt test</code></p>

<h1 id="known-issues">KNOWN ISSUES</h1>

<ul>
<li>Sails.js may act inconsistently when connecting with socket.io.  Running sudo npm install in the base of the app may resolve this.</li>
</ul></div></div></div></div></body></html>